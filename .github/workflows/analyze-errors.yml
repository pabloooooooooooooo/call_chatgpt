name: Analyze Errors with ChatGPT

on:
  workflow_call:
    inputs:
      logs:
        required: true
        type: string
      pr_number:
        required: true
        type: string
    secrets:
      OPENAI_API_KEY:
        required: true
      GH_TOKEN:
        required: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Appel API ChatGPT
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Construire le payload proprement
          payload=$(jq -n \
            --arg logs "${{ inputs.logs }}" \
            '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "Tu es un assistant DevOps. Analyse les logs dâ€™erreur de CI et explique la cause du problÃ¨me de maniÃ¨re concise."},
                {role: "user", content: $logs}
              ]
            }')

          echo "== Envoi Ã  OpenAI =="
          echo "$payload" | jq .

          # Appel de lâ€™API OpenAI
          response=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$payload" | jq -r '.choices[0].message.content // empty')

          # Sauvegarde de la rÃ©ponse pour lâ€™Ã©tape suivante
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "${response:-Aucune rÃ©ponse du modÃ¨le.}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post comment on PR
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          # Formater le commentaire en Markdown
          comment_body="### Analyse de l'erreur par l'assistant IA ðŸ¤–

          ${{ steps.chatgpt.outputs.response }}"

          gh pr comment ${{ inputs.pr_number }} --body "$comment_body"```
